"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_fs=_interopRequireDefault(require("fs")),_path=_interopRequireDefault(require("path")),_dayjs=_interopRequireDefault(require("dayjs")),_utils=require("../utils"),_rpks=require("../subpackages/rpks");function resolveFiles(e,t){var i=(0,_utils.lsdirdeep)(e);return i.includes(_rpks.DIGEST_ZIP_PATH)?(console.warning("检测到存在快游戏保留文件: ".concat(_rpks.DIGEST_ZIP_PATH)),!1):i=(0,_utils.sortFilesBy)(i,t)}function ZipPlugin(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this.options=Object.assign({priorities:["manifest.json","main.js"]},e)}function generateDistFile(e,t,i,a){var r="".concat(t.name,".").concat(t.sign,".").concat(a),s=_path.default.join(t.output,r);if(_fs.default.writeFileSync(s,e),_utils.colorconsole.log("### App Loader ### dist目录签名并生成".concat(a,"文件：").concat(r)),!i&&t.copyRpk){var o=(0,_dayjs.default)().format("YYYYMMDDhhmmss"),n="".concat(t.name,"_").concat(t.sign,"_").concat(t.versionCode,"_").concat(o,".").concat(a),c=_path.default.join(t.output,n);_fs.default.writeFileSync(c,e),_utils.colorconsole.log("### App Loader ### 复制".concat(a,"文件(").concat(r,")为文件(").concat(n,")"))}}ZipPlugin.prototype.apply=function(c){var l,u=this.options,e=u.projectPath,p={debug:{privatekey:_path.default.join(e,"sign/debug","private.pem"),certificate:_path.default.join(e,"sign/debug","certificate.pem")},release:{privatekey:_path.default.join(e,"sign/release","private.pem"),certificate:_path.default.join(e,"sign/release","certificate.pem")}}[u.sign];!u.disableSubpackages&&u.subpackages&&0<u.subpackages.length&&(l=u.subpackages),c.hooks.afterEmit.tapAsync("ZipPlugin",function(e,a){if(!p)return _utils.colorconsole.log("### App Loader ### 无签名配置项, 放弃打包: "+u.sign),void a();var t=p.privatekey,i=p.certificate;if(!_fs.default.existsSync(t))return _utils.colorconsole.log("### App Loader ### 缺少私钥文件, 打包失败: "+t),void a();if(!_fs.default.existsSync(i))return _utils.colorconsole.log("### App Loader ### 缺少证书文件, 打包失败: "+i),void a();t=_fs.default.readFileSync(t),i=_fs.default.readFileSync(i);var r=resolveFiles(u.pathBuild,u.priorities);if(!1!==r){var s=(0,_rpks.createPackagesDefinition)(l),o=s.fullPackage,n=s.subPackages;(0,_rpks.allocateResourceToPackages)(r,u.pathBuild,o,n),(0,_rpks.signZipPkgs)(u.name,t,i,o,n,u.disableStreamPack).then(function(e){var t=e.rpksBuffer,i=e.rpkBuffer;_fs.default.mkdir(u.output,function(){t&&generateDistFile(t,u,c.watchMode,"rpks"),generateDistFile(i,u,c.watchMode,"rpk"),a()})})}else a()})},module.exports=ZipPlugin;