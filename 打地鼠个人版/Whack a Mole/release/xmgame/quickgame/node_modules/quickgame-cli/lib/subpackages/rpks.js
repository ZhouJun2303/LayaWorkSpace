"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.createPackagesDefinition=createPackagesDefinition,exports.allocateResourceToPackages=allocateResourceToPackages,exports.signZipPkgs=signZipPkgs,exports.DIGEST_ZIP_PATH=void 0;var _objectSpread2=_interopRequireDefault(require("@babel/runtime/helpers/objectSpread")),_path=_interopRequireDefault(require("path")),_fs=_interopRequireDefault(require("fs")),_jszip=_interopRequireDefault(require("jszip")),_sign=require("../sign"),_utils=require("../utils"),MAIN_PKG_NAME="base",DIGEST_ZIP_PATH="META-INF/CERT";exports.DIGEST_ZIP_PATH=DIGEST_ZIP_PATH;var DEIGEST_HASH_JSON="hash.json",SINGLE_PKG_SIZE=5242880,FULL_PKG_SIZE=2*SINGLE_PKG_SIZE,COMPRESS_OPTS={type:"nodebuffer",compression:"DEFLATE",compressionOptions:{level:9}};function ClassPkgDef(e){Object.assign(this,{fileName:null,standalone:!1,subMatch:null,resourceList:[]},e)}function createFullPackage(){return new ClassPkgDef({fileName:"rpk",standalone:!0})}function createSubPackages(e){var r;r=[];var n=new ClassPkgDef({fileName:MAIN_PKG_NAME+".srpk",standalone:!0});return r.push(n),e.forEach(function(e){var n=e.root||e.resource,t=n;t=/\.js$/.test(n)?n:n+".*";var a=new ClassPkgDef({subMatch:new RegExp(t,"i"),fileName:e.name+".srpk",standalone:e.standalone||!1});r.push(a)}),r}function createPackagesDefinition(e){var n,t=createFullPackage();return e&&0<e.length&&(n=createSubPackages(e)),{fullPackage:t,subPackages:n}}function allocateResourceToPackages(e,u,c,f){e.forEach(function(e){var n=_path.default.join(u,e),t=_fs.default.readFileSync(n),a=[e,t,(0,_sign.getBufferDigest)(t)];if(c.addResource.apply(c,a),!f)return{fullPackage:c};for(var r=!0,i=1;i<f.length;i++){var s=f[i];if(s.standalone&&"manifest.json"===e&&s.addResource.apply(s,a),s.subMatch.test(e)){r=!1,s.addResource.apply(s,a);break}}if(r){var o=f[0];o.addResource.apply(o,a)}})}function signZipResourcesMeta(e,t,a){var n={};e.forEach(function(e){n[e.fileBuildPath]=e.fileContentDigest.toString("hex")});var r=new _jszip.default;return r.file(DEIGEST_HASH_JSON,JSON.stringify({algorithm:"SHA-256",digests:n})),r.generateAsync(COMPRESS_OPTS).then(function(e){var n={name:DEIGEST_HASH_JSON,hash:(0,_sign.getBufferDigest)(e)};return(0,_sign.signZip)(e,[n],t,a)})}function signPackageZip(e,t,a,r){var i=e.resourceList,s=new _jszip.default,o=i.map(function(e){return{name:e.fileBuildPath,hash:e.fileContentDigest}});return new Promise(function(n){r?n():signZipResourcesMeta(i,t,a).then(function(e){s.file(DIGEST_ZIP_PATH,e),o.unshift({name:DIGEST_ZIP_PATH,hash:(0,_sign.getBufferDigest)(e)}),n()})}).then(function(){var e=(0,_objectSpread2.default)({},COMPRESS_OPTS);return i.forEach(function(e){s.file(e.fileBuildPath,e.fileContentBuffer)}),s.generateAsync(e)}).then(function(e){return(0,_sign.signZip)(e,o,t,a)})}function signZipPkgs(u,n,a,r,c,e){return signPackageZip(r,n,a,e).then(function(t){if(!c)return{rpkBuffer:t};var i=new _jszip.default,s=[],o=0,e=c.map(function(e){return signPackageZip(e,n,a)});return Promise.all(e).then(function(e){e.forEach(function(e,n){var t=c[n],a="".concat(u,".").concat(t.fileName),r=e.length;o+=r,_utils.colorconsole.log("### App Loader ### '".concat(a,"' 大小为 ").concat(Math.ceil(r/1024)," KB")),SINGLE_PKG_SIZE<r&&_utils.colorconsole.warn("### App Loader ### 每个分包大小不能大于 ".concat(SINGLE_PKG_SIZE/1024," KB, '").concat(a,"' 已超出")),i.file(a,e),s.push({name:a,hash:(0,_sign.getBufferDigest)(e)})}),FULL_PKG_SIZE<o&&_utils.colorconsole.warn("### App Loader ### 所有分包总和大小不能大于 ".concat(FULL_PKG_SIZE/1024," KB, 已超出"));var n="".concat(u,".").concat(r.fileName);return i.file(n,t),s.push({name:n,hash:(0,_sign.getBufferDigest)(t)}),i.generateAsync(COMPRESS_OPTS)}).then(function(e){return{rpksBuffer:(0,_sign.signZip)(e,s,n,a),rpkBuffer:t}})})}ClassPkgDef.prototype.addResource=function(e,n,t){if(this.resourceList[e])throw new Error("### App Loader ### ".concat(e," 文件重复添加"));this.resourceList[e]=!0,this.resourceList.push({fileBuildPath:e,fileContentBuffer:n,fileContentDigest:t})};