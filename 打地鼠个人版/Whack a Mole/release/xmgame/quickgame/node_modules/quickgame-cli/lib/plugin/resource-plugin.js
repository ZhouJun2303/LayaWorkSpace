"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_path=_interopRequireDefault(require("path")),_fs=_interopRequireDefault(require("fs")),_utils=require("../utils"),FILE_INCLUDE_EXT=[".png",".jpg",".jpeg",".gif",".svg",".json",".cer",".obj",".dae",".fbx",".mtl",".stl",".3ds",".mp3",".pvr",".wav",".plist",".ttf",".fnt",".gz",".ccz",".m4a",".mp4",".bmp",".atlas",".swf",".ani",".part",".proto",".bin",".sk",".mipmaps",".txt",".zip",".ogg",".silk",".dbbin",".dbmv",".etc",".lmat",".lm",".ls",".lh",".lani",".lav",".lsani",".ltc",".csv",".scene",".prefab",".lml",".lmani",".ktx",".dds",".xml"],EXCLUDE_FILES=["package.json","package-lock.json","babel.config.js",".eslintrc.js",".eslintignore"],EXCLUDE_DIRS=[".DS_Store","Thumbs.db",".idea","dist","sign","node_modules"];function ResourcePlugin(e){this.options=e}function updateManifest(e,t){return e.config=e.config||{},e.config.debug=t,e.type||(e.type="game"),e}ResourcePlugin.prototype.apply=function(e){var u=this.options,o=e.options,c=u.cocosWxGame,t=u.includeFileExt?u.includeFileExt.split(","):[];FILE_INCLUDE_EXT.push.apply(FILE_INCLUDE_EXT,(0,_toConsumableArray2.default)(t));var i=u.ignoreDir&&u.ignoreDir.split(",")||[];EXCLUDE_DIRS=EXCLUDE_DIRS.concat(i),e.hooks.watchRun.tapAsync("ResourcePlugin",function(e,t){Object.keys(o.entry).forEach(function(e){var t=o.entry[e];t instanceof Array&&!/app\.js/.test(e)&&-1!==t[0].indexOf("webpack-dev-server")&&t.shift()}),t()}),e.hooks.emit.tapAsync("ResourcePlugin",function(e,n){var t=u.projectPath,o=u.pathBuild,s=e.compiler.inputFileSystem,r=e.compiler.outputFileSystem;c&&FILE_INCLUDE_EXT.unshift(".js");var i=new RegExp("(".concat(EXCLUDE_DIRS.join("|"),")")),a=(0,_utils.collectResFile)(t,o,FILE_INCLUDE_EXT,i,EXCLUDE_FILES),l=Object.keys(a).length;Object.keys(a).forEach(function(o){var i=a[o];r.mkdirp(_path.default.dirname(o),function(){var e=s.statSync(i);e&&e.isFile()&&s.readFile(i,function(e,t){e&&_utils.colorconsole.log("### App Loader ### 复制资源文件(".concat(i,")失败：").concat(e.message)),r.writeFile(o,t,function(e){e&&_utils.colorconsole.log("### App Loader ### 复制资源文件(".concat(o,")失败：").concat(e.message)),function(){if(0<--l)return;_utils.colorconsole.log("### App Loader ### build目录构建完成"),n()}()})})})})}),e.hooks.emit.tapAsync("ResourcePlugin",function(e,t){var o=u.projectPath,i=u.pathBuild,n=_path.default.join(o,"manifest.json"),s=_path.default.join(i,"manifest.json");if(_fs.default.existsSync(n)){var r;try{var a=_fs.default.readFileSync(n,"utf8");r=JSON.parse(a)}catch(e){throw _utils.colorconsole.error("ERROR: 解析 manifest.json 文件出错 %s",e.message),e}var l=!u.sign;r=updateManifest(r,l);var c=JSON.stringify(r,null,l?2:0);_fs.default.writeFile(s,c,"utf8",function(e){e&&_utils.colorconsole.error("### App Loader ### 更新 %s 失败：%s",e.message),t()})}else _utils.colorconsole.error("### App Loader ### %s 下无 manifest.json 文件"),t()})},module.exports=ResourcePlugin;