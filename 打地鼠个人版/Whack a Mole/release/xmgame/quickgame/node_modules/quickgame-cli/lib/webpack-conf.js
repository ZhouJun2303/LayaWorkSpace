"use strict";var projectPath,manifestJson,_interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_path=_interopRequireDefault(require("path")),_fs=_interopRequireDefault(require("fs")),_del=_interopRequireDefault(require("del")),_zipPlugin=_interopRequireDefault(require("./plugin/zip-plugin")),_resourcePlugin=_interopRequireDefault(require("./plugin/resource-plugin")),_notifyPlugin=_interopRequireDefault(require("./plugin/notify-plugin")),_utils=require("./utils"),excludeDir=[".DS_Store","Thumbs.db",".idea","build","dist","sign","node_modules"],MAIN_PKG_NAME="base",RPKS_SUPPORT_VERSION_FROM=1040;function checkConfig(e,t,a){_fs.default.existsSync(a)?validateManifest(e,t):_utils.colorconsole.error("项目 ".concat(a," 下找不到入口文件 main.js"))}function validateManifest(e,t){t.icon||_utils.colorconsole.error("manifest.json 中未配置图标icon"),t.package||_utils.colorconsole.error("manifest.json 未定义包名(package)");var a=t.subpackages;!e.disableSubpackages&&a&&1<a.length&&validateManifestSubpackages(a)}function useStrictMode(e){var t=_path.default.join(projectPath,"package.json");if(_fs.default.existsSync(t)){var a=JSON.parse(_fs.default.readFileSync(t));e?a.babel&&(delete a.babel,_fs.default.writeFileSync(t,JSON.stringify(a,null,"\t")),console.info('编译代码进行严格模式声明："use strict"')):a.babel||(a.babel={plugins:["babel-plugin-transform-remove-strict-mode"]},_fs.default.writeFileSync(t,JSON.stringify(a,null,"\t")))}else console.info("请查看 ".concat(t," 路径下是否存在package.json文件"))}function findUxFilesByManifest(e,t){var a=[];a.push({resource:"main.js"});var o=t.subpackages;return t&&o&&o.forEach(function(e){a.push(e)}),a}function collectFiles(e,o){var n=_path.default.resolve(projectPath,e),s=new RegExp("(".concat(excludeDir.join("|"),")"));_fs.default.readdirSync(n).forEach(function(e){if(!e.match(s)){var t=_path.default.resolve(n,e),a=_fs.default.statSync(t);a.isFile()&&".js"===_path.default.extname(e)&&!e.match(/cocos.*/g)?(t=_path.default.relative(projectPath,t).replace(/\\/,"/"),o.push({resource:t})):a.isDirectory()&&collectFiles(t,o)}})}function buildWebpackEntries(e){var r,i={};return e.forEach(function(e){var t=e.resource||e.root,a=_path.default.extname(t),o=t.replace(a,"");if(a){var n=t.replace(a,"");r=_path.default.join(projectPath,n)}else{var s=t;/\.js$/.test(t)?s=t:/\/$/.test(t)?(s=t+"main.js",o=t+"main"):_utils.colorconsole.throw("manifest.json中的文件路劲配置存在问题".concat(t)),r=_path.default.join(projectPath,s)}i[o]=r}),i}function getJson(e){var t;return _fs.default.existsSync(e)&&(t=JSON.parse(_fs.default.readFileSync(e))),t||{}}function validateManifestSubpackages(e){var a=[],o=[],n="",s="",r="",i=0;e.forEach(function(e,t){n=e.name,s=e.resource||e.root,r=s&&_path.default.join(projectPath,s),i=t+1,n?n===MAIN_PKG_NAME?_utils.colorconsole.throw("第".concat(i,"分包的名字'").concat(n,"'是主包保留名，请修改")):-1<a.indexOf(n)?_utils.colorconsole.throw("第".concat(i,"分包的名字'").concat(n,"'已存在，请修改")):a.push(n):_utils.colorconsole.throw("第".concat(i,"分包的名字不能为空，请添加")),s?-1<o.indexOf(s)?_utils.colorconsole.throw("第".concat(i,"分包的资源'").concat(s,"'已被使用，请修改")):_fs.default.existsSync(r)||_utils.colorconsole.throw("第".concat(i,"分包的资源'").concat(s,"', 文件目录'").concat(r,"'不存在，请修改")):_utils.colorconsole.throw("第".concat(i,"分包的资源名不能为空，请添加"))});var t=manifestJson.minPlatformVersion;parseInt(t)<RPKS_SUPPORT_VERSION_FROM&&_utils.colorconsole.warn("项目已配置分包，若想使用分包功能，请确保平台版本 >= ".concat(RPKS_SUPPORT_VERSION_FROM))}module.exports=function(e,t){var a=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"";projectPath=a||process.cwd();var o=_path.default.resolve(projectPath,"build"),n=_path.default.resolve(projectPath,"dist"),s=_path.default.resolve(projectPath,"manifest.json"),r={appPackageName:(manifestJson=getJson(s)).package},i=_path.default.join(projectPath,"main.js");checkConfig(e,manifestJson,i);var l=buildWebpackEntries(findUxFilesByManifest(e.cocosWxGame,manifestJson));e.server||_del.default.sync([n,o]),useStrictMode(e.strictMode);var c="production"===t,u=c?"release":"debug",f=c?"none":"source-map",p=e.watch||!1,d=manifestJson.subpackages,_={mode:t,entry:l,output:{path:o,filename:"[name].js"},context:a||_path.default.resolve(__dirname),module:{rules:[]},watch:p,watchOptions:{ignored:/node_modules/},devtool:f,resolve:{modules:["./","node_modules"]},node:{global:!1,url:!0,process:!1,fs:"empty",Buffer:!1},resolveLoader:{modules:[_path.default.resolve(__dirname,"./loaders"),"node_modules"]},plugins:[new _zipPlugin.default({name:manifestJson.package,versionCode:manifestJson.versionCode,projectPath:projectPath,output:n,pathBuild:o,sign:u,priorities:["manifest.json","main.js"],subpackages:d,copyRpk:e.copyRpk,disableStreamPack:e.disableStreamPack,disableSubpackages:e.disableSubpackages}),new _resourcePlugin.default({pathBuild:o,sign:c,projectPath:projectPath,ignoreDir:e.ignore,cocosWxGame:e.cocosWxGame,includeFileExt:e.includeFileExt})],externals:[function(e,t,a){if(t.match(/@\w+(.\w+)+/g))return a(null,'$require$("@module/'.concat(t.slice(1),'")'));a()}]};return e.jestMode||_.plugins.push(new _notifyPlugin.default),e.cocosWxGame&&_.module.rules.push({test:/\.js$/,use:{loader:"resolveRequire"}}),{webpackConf:_,exOptions:r}};